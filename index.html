<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Dietician App with Auth0 Admin Integration</title>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCbf2_Tix099atneixgZj_h2lIiQ91-TOg",
    authDomain: "fluted-agency-468912-d7.firebaseapp.com",
    projectId: "fluted-agency-468912-d7",
    storageBucket: "fluted-agency-468912-d7.firebasestorage.app",
    messagingSenderId: "566546517830",
    appId: "1:566546517830:web:f9d781bcbe610d3b36df47",
    measurementId: "G-3KL69HPWKR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

  <!-- Firebase App (the core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<head>
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LeqFLUrAAAAAOdqFseYKrhyENDkl7FKmOWqcykD"></script>
  <!-- Your code -->
</head>
  <!-- Replace the variables below. -->
<script>
  function onSubmit(token) {
    document.getElementById("demo-form").submit();
  }
</script>

  <script>
    exports.onExecutePostLogin = async (event, api) => {
  api.multifactor.enable('guardian', { allowRememberBrowser: false });
};
  </script>

  <script>
exports.onExecutePostLogin = async (event, api) => {
const groups = event.user.app_metadata.authorization.groups;
const GROUPS_WITH_MFA = {
// Add groups that need MFA here
// Example
admins: true
};

const needsMFA = !!groups.find(function (group) {
return GROUPS_WITH_MFA[group];
});

if (needsMFA) {
// optional, defaults to true. Set to false to force Guardian authentication every time.
// See https://auth0.com/docs/secure/multi-factor-authentication/customize-mfa#change-frequency-of-mfa-prompts for details
api.multifactor.enable('guardian', { allowRememberBrowser: false });
}

};
    
  </script>
    
<style>
  /* Your existing CSS unchanged */
  html, body {
    margin: 0; padding: 0;
    width: 100%; min-height: 100vh;
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: white;
    overflow: auto;
    position: relative;
  }
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent);
    background-size: 20px 20px;
    pointer-events: none;
    z-index: -1;
  }
  #appPanel {
    position: relative;
    max-width: 850px;
    margin: 40px auto 60px;
    background: rgba(20,20,20,0.95);
    border-radius: 16px;
    box-shadow: 0 0 35px rgba(0,255,255,0.15);
    padding: 30px 40px;
    z-index: 10;
  }
  #appPanel h1, #appPanel h2, #dosWidget h2 {
    color: #00fff7;
    margin: 0 0 20px 0;
    font-weight: 700;
    text-align: center;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  input, select, textarea, button {
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 18px;
    border-radius: 8px;
    background: #222;
    border: 1px solid #444;
    color: #fff;
    font-size: 1em;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #00fff7;
    box-shadow: 0 0 10px #00fff7;
  }
  button {
    cursor: pointer;
    border: none;
    background: #00fff7;
    color: #111;
    font-weight: 700;
    transition: background 0.3s;
  }
  button:hover:not(:disabled) {
    background: #00ccc7;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  textarea {
    resize: vertical;
    min-height: 160px;
    max-height: 320px;
    font-family: monospace;
  }
  .row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .col {
    flex: 1;
    min-width: 170px;
  }
  #dosWidget {
    margin: 40px auto 60px;
    padding: 30px 40px;
    background: rgba(20,20,20,0.95);
    border-radius: 16px;
    box-shadow: 0 0 35px rgba(0,255,255,0.15);
    color: #8df9e1;
    max-width: 850px;
    min-height: 350px;
    max-height: 520px;
    overflow-y: auto;
    white-space: pre-wrap;
    user-select: text;
  }
  #buttonsGroup {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  #buttonsGroup button {
    flex: 1;
    min-width: 120px;
  }
</style>
</head>
<body>
<div id="appPanel">
  <h1>Advanced Dietician App</h1>
  <section>
    <h2>Profile Information</h2>
    <div class="row">
      <div class="col"><label for="age">Age (years)</label><input id="age" type="number" placeholder="30" /></div>
      <div class="col"><label for="weight">Weight (kg)</label><input id="weight" type="number" placeholder="70" /></div>
      <div class="col"><label for="height">Height (cm)</label><input id="height" type="number" placeholder="175" /></div>
      <div class="col" style="flex-grow: 2;"><label for="diet">Diet Preference</label><input id="diet" type="text" placeholder="e.g. Vegan, Keto" /></div>
    </div>
    <div id="buttonsGroup">
      <button id="calcBtn">Calculate BMI & Advice</button>
      <button id="resetBtn" title="Reset all">Reset All</button>
      <button id="printBmiBtn" title="Print BMI">Print</button>
      <button id="saveBmiBtn" title="Save BMI">Save</button>
      <button id="emailBmiBtn" title="Email BMI">Email</button>
    </div>
    <textarea id="bmiAdvice" readonly></textarea>
  </section>
  <section>
    <h2>Nutrition Lookup</h2>
    <input id="foodQuery" type="text" placeholder="Enter food name" />
    <div id="buttonsGroup">
      <button id="searchBtn">Search</button>
      <button id="printNutritionBtn" title="Print Nutrition">Print</button>
      <button id="saveNutritionBtn" title="Save Nutrition">Save</button>
      <button id="emailNutritionBtn" title="Email Nutrition">Email</button>
    </div>
    <textarea id="nutritionResult" readonly></textarea>
  </section>
</div>
<div id="dosWidget" aria-live="polite">
  <h2>Do's & Don'ts & Wellness Tips</h2>
  <select id="goalSelect" aria-label="Select goal">
    <option value="" selected disabled>Choose goal</option>
    <option value="Lose">Lose Weight</option>
    <option value="Gain">Gain Weight</option>
    <option value="Maintain">Maintain Weight</option>
  </select>
  <div id="buttonsGroup" style="margin-top: 16px;">
    <button id="showDosBtn">Show Recommendations</button>
    <button id="printDosBtn" title="Print Dos & Don'ts">Print</button>
    <button id="saveDosBtn" title="Save Dos & Don'ts">Save</button>
    <button id="emailDosBtn" title="Email Dos & Don'ts">Email</button>
  </div>
  <pre id="dosOutput"></pre>
</div>
<script src="https://cdn.auth0.com/js/auth0-spa-js/1.26/auth0-spa-js.production.js"></script>
<script>
  let auth0 = null;
  let isAdmin = false;

  async function initAuth0() {
    auth0 = await createAuth0Client({
      domain: "<dev-sqxaaq5amj4faxzm.us.auth0.com>",
      client_id: "<ThQA3ppjE67XCdG1Xv1mE9sv4CnqJbkf>",
      cacheLocation: 'localstorage'
    });

    if(window.location.search.includes('code=') && window.location.search.includes('state=')){
      await auth0.handleRedirectCallback();
      window.history.replaceState({}, document.title, "/");
    }

    const isAuthenticated = await auth0.isAuthenticated();

    if(!isAuthenticated){
      await auth0.loginWithRedirect({
        redirect_uri: window.location.origin
      });
    } else {
      const user = await auth0.getUser();
      // Check custom roles claim, e.g. https://your-app.com/roles
      const roles = user['https://your-app.com/roles'] || [];
      isAdmin = roles.includes('admin');

      toggleAdminFeatures();
      console.log('Authenticated user:', user);
    }
  }

  function toggleAdminFeatures() {
    const adminButtons = [
      'printBmiBtn','saveBmiBtn','emailBmiBtn',
      'printNutritionBtn','saveNutritionBtn','emailNutritionBtn',
      'printDosBtn','saveDosBtn','emailDosBtn'
    ];
    adminButtons.forEach(id => {
      const btn = document.getElementById(id);
      if(btn){
        btn.style.display = isAdmin ? 'inline-block' : 'none';
        btn.disabled = !isAdmin;
      }
    });
  }

  function saveTextFile(filename, text){
    const blob = new Blob([text], { type:'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function sendEmail(subject, body){
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  function printContent(id){
    const el = document.getElementById(id);
    const content = el.value || el.textContent;
    const w = window.open();
    w.document.write('<pre style="font-family: monospace; white-space: pre-wrap; font-size: 16px;">' + content + '</pre>');
    w.document.close();
    w.focus();
    w.print();
    w.close();
  }

  document.getElementById('resetBtn').addEventListener('click', () => {
    ['age','weight','height','diet','goalSelect','foodQuery'].forEach(id=>{
      const el = document.getElementById(id);
      if(el.tagName.toLowerCase() === "select"){
        el.selectedIndex = 0;
      } else {
        el.value = "";
      }
    });
    ['bmiAdvice','nutritionResult','dosOutput'].forEach(id=>{
      const el = document.getElementById(id);
      if('value' in el){
        el.value = "";
      } else {
        el.textContent = "";
      }
    });
  });

  // BMI calculation & display
  document.getElementById('calcBtn').addEventListener('click', () => {
    const age = document.getElementById('age').value.trim();
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const diet = document.getElementById('diet').value.trim() || 'None';

    if(!weight || !height || weight <= 0 || height <= 0){
      alert('Please enter valid weight and height');
      return;
    }
    const bmi = weight / ((height/100) * (height/100));
    const category = getBmiCategory(bmi);
    const advice = generateDetailedAdvice(weight, height, bmi, category, age, diet, "General");

    document.getElementById('bmiAdvice').value = advice;
  });

  // Nutrition lookup
  document.getElementById('searchBtn').addEventListener('click', async () => {
    const food = document.getElementById('foodQuery').value.trim();
    const output = document.getElementById('nutritionResult');
    if(!food){
      alert('Please enter a food name');
      return;
    }
    output.value = 'Loading nutrition info...';
    try {
      const apiKey = '<evbkpkYjm9qBAe6gXrcAgIhhFechn8Tj3Yd4AuIp>'; // Replace with your USDA API key
      const response = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${apiKey}&query=${encodeURIComponent(food)}&pageSize=1`);
      const data = await response.json();
      if(!data.foods || data.foods.length === 0){
        output.value = 'No nutrition data found.';
        return;
      }
      const item = data.foods[0];
      let nutrients = {};
      item.foodNutrients.forEach(n=>{
        let nName = n.nutrientName.toLowerCase();
        if(nName.includes('energy')) nutrients.Calories = n.value;
        if(nName.includes('protein')) nutrients.Protein = n.value;
        if(nName.includes('fat')) nutrients.Fat = n.value;
        if(nName.includes('carbohydrate')) nutrients.Carbohydrates = n.value;
      });
      let result = `${item.description} (per serving):\n`;
      for(const [key,val] of Object.entries(nutrients)){
        result += `${key}: ${val}\n`;
      }
      output.value = result;
    } catch(e){
      output.value = 'Error fetching nutrition data.';
    }
  });

  // Do's & Don'ts generation
  document.getElementById('showDosBtn').addEventListener('click', () => {
    const goal = document.getElementById('goalSelect').value;
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const diet = document.getElementById('diet').value.trim() || 'None';

    if(!goal){
      alert('Please select your goal');
      return;
    }
    if(!weight || !height || weight <= 0 || height <= 0){
      alert('Please enter valid weight and height');
      return;
    }

    const bmi = weight / ((height/100) * (height/100));
    const category = getBmiCategory(bmi);
    const guide = generateGuide(goal, category, diet);
    document.getElementById('dosOutput').textContent = guide;
  });

  function getBmiCategory(bmi){
    if(bmi < 16.5) return "Severely Underweight";
    if(bmi < 18.5) return "Underweight";
    if(bmi < 25) return "Normal weight";
    if(bmi < 30) return "Overweight";
    if(bmi < 35) return "Obesity Class I";
    if(bmi < 40) return "Obesity Class II";
    return "Obesity Class III";
  }

  function generateDetailedAdvice(weight, height, bmi, category, age, diet, goal){
    let advice = `=== BMI Calculation & Health Advice ===\n\n`;
    advice += `Step 1: Convert height from cm to meters:\n  ${height} cm = ${(height/100).toFixed(2)} m\n\n`;
    advice += `Step 2: Square the height in meters:\n  ${(height/100).toFixed(2)} × ${(height/100).toFixed(2)} = ${(height/100 * height/100).toFixed(4)} m²\n\n`;
    advice += `Step 3: Calculate BMI:\n  ${weight} ÷ ${(height/100*height/100).toFixed(4)} = ${bmi.toFixed(1)}\n\n`;
    advice += `BMI Category: ${category}\n\n`;
    // Add category specific advice, wellness tips etc.
    // Simplified here for brevity
    advice += `Weight Goal: ${goal}\n`;
    advice += `Diet Preference: ${diet}\n\nMaintain a balanced diet and regular exercise.\n`;
    advice += `\nConsult healthcare professionals for personalized advice.\n`;
    return advice;
  }

  function generateGuide(goal,bmiCat,diet){
    // Generate actionable do's & don'ts text here (omitted for brevity, use previous implementations)
    return "Personalized Do's & Don'ts based on goal, BMI and diet.";
  }

  // Admin export controls blocked for non-admin users
  function checkAdmin(){
    if(!isAdmin){
      alert("Only admins can perform this action.");
      return false;
    }
    return true;
  }
  // Export events:
  ['Bmi','Nutrition','Dos'].forEach(section=>{
    const printBtn=document.getElementById('print'+section+'Btn');
    if(printBtn) printBtn.addEventListener('click', () => {
      if(!checkAdmin()) return;
      printContent(section.toLowerCase()+'Output' in document ? section.toLowerCase()+'Output' : section.toLowerCase()+'Advice');
    });
    const saveBtn=document.getElementById('save'+section+'Btn');
    if(saveBtn) saveBtn.addEventListener('click', () => {
      if(!checkAdmin()) return;
      const id = section.toLowerCase()+'Output' in document ? section.toLowerCase()+'Output' : section.toLowerCase()+'Advice';
      const el=document.getElementById(id);
      const text= el.value || el.textContent;
      saveTextFile(section.toLowerCase()+'_data.txt', text);
    });
    const emailBtn=document.getElementById('email'+section+'Btn');
    if(emailBtn) emailBtn.addEventListener('click', () => {
      if(!checkAdmin()) return;
      const id = section.toLowerCase()+'Output' in document ? section.toLowerCase()+'Output' : section.toLowerCase()+'Advice';
      const el=document.getElementById(id);
      const text= el.value || el.textContent;
      sendEmail(section+' Data', text);
    });
  });

</script>
  <script>import com.google.cloud.recaptchaenterprise.v1.RecaptchaEnterpriseServiceClient;
import com.google.recaptchaenterprise.v1.Assessment;
import com.google.recaptchaenterprise.v1.CreateAssessmentRequest;
import com.google.recaptchaenterprise.v1.Event;
import com.google.recaptchaenterprise.v1.ProjectName;
import com.google.recaptchaenterprise.v1.RiskAnalysis.ClassificationReason;
import java.io.IOException;

public class CreateAssessment {

  public static void main(String[] args) throws IOException {
    // TO-DO: Replace the token and reCAPTCHA action variables before running the sample.
    String projectID = "fluted-agency-468912-d7";
    String recaptchaKey = "6LeqFLUrAAAAAOdqFseYKrhyENDkl7FKmOWqcykD";
    String token = "action-token";
    String recaptchaAction = "action-name";

    createAssessment(projectID, recaptchaKey, token, recaptchaAction);
  }

  /**
   * Create an assessment to analyse the risk of a UI action.
   *
   * @param projectID : Your Google Cloud project ID.
   * @param recaptchaKey : The reCAPTCHA key associated with the site/app
   * @param token : The generated token obtained from the client.
   * @param recaptchaAction : Action name corresponding to the token.
   */
  public static void createAssessment(
      String projectID, String recaptchaKey, String token, String recaptchaAction)
      throws IOException {
    // Create the reCAPTCHA client.
    // TODO: Cache the client generation code (recommended) or call client.close() before exiting the method.
    try (RecaptchaEnterpriseServiceClient client = RecaptchaEnterpriseServiceClient.create()) {

      // Set the properties of the event to be tracked.
      Event event = Event.newBuilder().setSiteKey(recaptchaKey).setToken(token).build();

      // Build the assessment request.
      CreateAssessmentRequest createAssessmentRequest =
          CreateAssessmentRequest.newBuilder()
              .setParent(ProjectName.of(projectID).toString())
              .setAssessment(Assessment.newBuilder().setEvent(event).build())
              .build();

      Assessment response = client.createAssessment(createAssessmentRequest);

      // Check if the token is valid.
      if (!response.getTokenProperties().getValid()) {
        System.out.println(
            "The CreateAssessment call failed because the token was: "
                + response.getTokenProperties().getInvalidReason().name());
        return;
      }

      // Check if the expected action was executed.
      if (!response.getTokenProperties().getAction().equals(recaptchaAction)) {
        System.out.println(
            "The action attribute in reCAPTCHA tag is: "
                + response.getTokenProperties().getAction());
        System.out.println(
            "The action attribute in the reCAPTCHA tag "
                + "does not match the action ("
                + recaptchaAction
                + ") you are expecting to score");
        return;
      }

      // Get the risk score and the reason(s).
      // For more information on interpreting the assessment, see:
      // https://developers.google.com/recaptcha-enterprise/docs/interpret-assessment
      for (ClassificationReason reason : response.getRiskAnalysis().getReasonsList()) {
        System.out.println(reason);
      }

      float recaptchaScore = response.getRiskAnalysis().getScore();
      System.out.println("The reCAPTCHA score is: " + recaptchaScore);

      // Get the assessment name (ID). Use this to annotate the assessment.
      String assessmentName = response.getName();
      System.out.println(
          "Assessment name: " + assessmentName.substring(assessmentName.lastIndexOf("/") + 1));
    }
  }
}</script>
</body>
</html>
